<template>
  <div class="mood-log">
    <div class="header">
      <h1>Mood Log</h1>
      <div class="no-print">
        <button v-on:click="onPrintClick">Print</button>
        <button v-on:click="onClearClick">Clear</button>
      </div>
    </div>
    <div class="mood-log">
      <div><mood-log-situation
        v-bind:situation="log.situation"
        v-on:update="onSituationUpdate"
      ></mood-log-situation></div>
      <div><mood-log-emotions
        v-bind:emotions="log.emotions"
        v-bind:other-emotions="log.otherEmotions"
        v-on:update="onEmotionUpdate"
        v-on:add="onOtherEmotionAdd"
        v-on:remove="onOtherEmotionRemove"
      ></mood-log-emotions></div>
      <div><mood-log-thoughts
        v-bind:thoughts="log.thoughts"
        v-on:update="onThoughtUpdate"
        v-on:update-distortion="onDistortionUpdate"
        v-on:add="onThoughtAdd"
        v-on:remove="onThoughtRemove"
      ></mood-log-thoughts></div>
      <div><mood-log-emotions
        class="no-print"
        v-bind:secondary="true"
        v-bind:emotions="log.emotions"
        v-bind:other-emotions="log.otherEmotions"
        v-on:update="onEmotionUpdate"
        v-on:update-other="onOtherEmotionUpdate"
        v-on:add="onOtherEmotionAdd"
        v-on:remove="onOtherEmotionRemove"
      ></mood-log-emotions></div>
    </div>
    <div class="footer">
      <div class="no-print">
        <button v-on:click="onPrintClick">Print</button>
        <button v-on:click="onClearClick">Clear</button>
      </div>
    </div>
  </div>
</template>

<script lang="ts">
  import Vue from 'vue';
  import Component from 'vue-class-component';
  import allEmotions, {EmotionMap} from 'data/emotions';
  import allDistortions, {DistortionMap} from 'data/distortions';
  import MoodLogEmotions, {EmotionInfo, OtherEmotionInfo} from './MoodLogEmotions.vue';
  import MoodLogSituation from './MoodLogSituation.vue';
  import MoodLogThoughts, {ThoughtInfo} from './MoodLogThoughts.vue';
  const SAVE_KEY = 'v1';
  const SAVE_DELAY_MS = 1 * 1000;
  function buildEmotionData(): EmotionInfo {
    return {
      before: '',
      goal: '',
      after: '',
    };
  }
  function buildOtherEmotionData(): OtherEmotionInfo {
    return {
      name: '',
      before: '',
      goal: '',
      after: '',
    };
  }
  function buildThoughtData(): ThoughtInfo {
    const distortions: {[K in keyof DistortionMap]: boolean} = {};
    for (const id in allDistortions) {
      distortions[id] = false;
    }
    return {
      automatic: '',
      before: '',
      after: '',
      distortions,
      realistic: '',
      belief: '',
    };
  };
  interface LogData {
    situation: string;
    emotions: {[K in keyof EmotionMap]: EmotionInfo};
    otherEmotions: Array<OtherEmotionInfo>;
    thoughts: Array<ThoughtInfo>;
  }
  function buildLogData(): LogData {
    const situation = '';
    const emotions: {[key: string]: EmotionInfo} = {};
    const otherEmotions = [buildOtherEmotionData()];
    const thoughts: Array<ThoughtInfo> = [];
    for (const id in allEmotions) {
      emotions[id] = buildEmotionData();
    }
    for (let i = 0; i < 5; i++) {
      thoughts.push(buildThoughtData());
    }
    return {situation, emotions, otherEmotions, thoughts};
  };
  @Component({
    name: 'mood-log',
    components: { MoodLogEmotions, MoodLogSituation, MoodLogThoughts },
  })
  export default class extends Vue {
    log: LogData = buildLogData();
    timeoutId: number = 0;
    beforeUnloadListener = () => this.saveNow();
    beforeMount() {
      // TODO: Better type checking for saved data?
      if (SAVE_KEY in window.localStorage) {
        let loaded: LogData | null;
        try {
          loaded = JSON.parse(window.localStorage[SAVE_KEY]);
        } catch (e) {
          console.error('Failed to load previous mood log:');
          console.error(e);
          loaded = null;
        }
        if (loaded) {
          for (const key in this.log) {
            if (key in loaded) {
              const logKey: keyof LogData = key as keyof LogData;
              this.log[logKey] = loaded[logKey];
            }
          }
        }
      }
      window.addEventListener('beforeunload', this.beforeUnloadListener);
    }
    destroyed() {
      window.removeEventListener('beforeunload', this.beforeUnloadListener);
    }
    saveNow() {
      window.localStorage[SAVE_KEY] = JSON.stringify(this.log);
    }
    deferSave() {
      if (this.timeoutId) {
        window.clearTimeout(this.timeoutId);
      }
      this.timeoutId = window.setTimeout(() => {
        this.saveNow();
        this.timeoutId = 0;
      }, SAVE_DELAY_MS);
    }
    onPrintClick() {
      this.saveNow();
      window.print();
    }
    onClearClick() {
      if (window.confirm('Are you SURE you want to clear the mood log?')) {
        this.log = buildLogData();
      }
    }
    onSituationUpdate(value: string) {
      this.log.situation = value;
      this.deferSave();
    }
    onEmotionUpdate(id: string, field: keyof EmotionInfo, value: string) {
      this.log.emotions[id][field] = value;
      this.deferSave();
    }
    onOtherEmotionUpdate(index: number, field: keyof OtherEmotionInfo, value: string) {
      this.log.otherEmotions[index][field] = value;
      this.deferSave();
    }
    onOtherEmotionAdd(id: number) {
      this.log.otherEmotions.splice(id + 1, 0, buildOtherEmotionData());
      this.deferSave();
    }
    onOtherEmotionRemove(id: number) {
      if (this.log.otherEmotions.length > 1) {
        this.log.otherEmotions.splice(id, 1);
        this.deferSave();
      }
    }
    onThoughtUpdate(index: number, field: keyof ThoughtInfo, value: string) {
      this.log.thoughts[index][field] = value;
      this.deferSave();
    }
    onDistortionUpdate(index: number, distortionId: keyof DistortionMap, value: boolean) {
      this.log.thoughts[index].distortions[distortionId] = value;
      this.deferSave();
    }
    onThoughtAdd(index: number) {
      this.log.thoughts.splice(index + 1, 0, buildThoughtData());
      this.deferSave();
    }
    onThoughtRemove(index: number) {
      if (this.log.thoughts.length > 1) {
        this.log.thoughts.splice(index, 1);
        this.deferSave();
      }
    }
  };
</script>

<style lang='scss' scoped>
  @import '~styles/shared-styles.scss';
  .mood-log > div:not(:last-child) {
    margin-bottom: 3rem;
  }
  .header, .footer {
    text-align: center;
  }
</style>