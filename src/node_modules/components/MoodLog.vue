<template>
  <div class="mood-log">
    <div class="header">
      <h1>Mood Log</h1>
      <div class="no-print">
        <button v-on:click="onPrintClick">Print</button>
        <button v-on:click="onClearClick">Clear</button>
      </div>
    </div>
    <div class="mood-log">
      <div><mood-log-situation
        v-bind:situation="log.situation"
        v-on:update="onSituationUpdate"
      ></mood-log-situation></div>
      <div><mood-log-emotions
        v-bind:emotions="log.emotions"
        v-bind:other-emotions="log.otherEmotions"
        v-on:update="onEmotionUpdate"
        v-on:add="onOtherEmotionAdd"
        v-on:remove="onOtherEmotionRemove"
      ></mood-log-emotions></div>
      <div><mood-log-thoughts
        v-bind:thoughts="log.thoughts"
        v-on:update="onThoughtUpdate"
        v-on:update-distortion="onDistortionUpdate"
        v-on:add="onThoughtAdd"
        v-on:remove="onThoughtRemove"
      ></mood-log-thoughts></div>
      <div><mood-log-emotions
        class="no-print"
        v-bind:secondary="true"
        v-bind:emotions="log.emotions"
        v-bind:other-emotions="log.otherEmotions"
        v-on:update="onEmotionUpdate"
        v-on:add="onOtherEmotionAdd"
        v-on:remove="onOtherEmotionRemove"
      ></mood-log-emotions></div>
    </div>
    <div class="footer">
      <div class="no-print">
        <button v-on:click="onPrintClick">Print</button>
        <button v-on:click="onClearClick">Clear</button>
      </div>
    </div>
  </div>
</template>

<script>
  import allEmotions from 'data/emotions';
  import allDistortions from 'data/distortions';
  import MoodLogEmotions from './MoodLogEmotions.vue';
  import MoodLogSituation from './MoodLogSituation.vue';
  import MoodLogThoughts from './MoodLogThoughts.vue';
  const SAVE_KEY = 'v1';
  const SAVE_DELAY_MS = 1 * 1000;
  const buildEmotionData = () => ({
    before: '',
    goal: '',
    after: '',
  });
  const buildOtherEmotionData = () => {
    const data = buildEmotionData();
    data.name = '';
    return data;
  };
  const buildThoughtData = () => {
    const distortions = {};
    for (const id in allDistortions) {
      distortions[id] = false;
    }
    return {
      automatic: '',
      before: '',
      after: '',
      distortions,
      realistic: '',
      belief: '',
    };
  };
  const buildLogData = () => {
    const situation = '';
    const emotions = {};
    const otherEmotions = [buildOtherEmotionData()];
    const thoughts = [];
    for (const id in allEmotions) {
      emotions[id] = buildEmotionData();
    }
    for (let i = 0; i < 5; i++) {
      thoughts.push(buildThoughtData());
    }
    return {situation, emotions, otherEmotions, thoughts};
  };
  export default {
    name: 'mood-log',
    components: { MoodLogEmotions, MoodLogSituation, MoodLogThoughts },
    data() {
      return {
        log: buildLogData(),
        timeoutId: 0,
        beforeUnloadListener: () => this.saveNow(),
      };
    },
    beforeMount() {
      if (SAVE_KEY in window.localStorage) {
        let loaded;
        try {
          loaded = JSON.parse(window.localStorage[SAVE_KEY]);
        } catch (e) {
          console.error('Failed to load previous mood log:');
          console.error(e);
          loaded = null;
        }
        if (loaded) {
          for (const key in this.log) {
            this.log[key] = loaded[key];
          }
        }
      }
      window.addEventListener('beforeunload', this.beforeUnloadListener);
    },
    destroyed() {
      window.removeEventListener('beforeunload', this.beforeUnloadListener);
    },
    methods: {
      saveNow() {
        window.localStorage[SAVE_KEY] = JSON.stringify(this.log);
      },
      deferSave() {
        if (this.timeoutId) {
          window.clearTimeout(this.timeoutId);
        }
        this.timeoutId = window.setTimeout(() => {
          this.saveNow();
          this.timeoutId = 0;
        }, SAVE_DELAY_MS);
      },
      onPrintClick() {
        this.saveNow();
        window.print();
      },
      onClearClick() {
        if (window.confirm('Are you SURE you want to clear the mood log?')) {
          this.log = buildLogData();
        }
      },
      onSituationUpdate(value) {
        this.log.situation = value;
        this.deferSave();
      },
      onEmotionUpdate(id, field, value) {
        const source = typeof id === 'number' ? this.log.otherEmotions : this.log.emotions;
        source[id][field] = value;
        this.deferSave();
      },
      onOtherEmotionAdd(id) {
        this.log.otherEmotions.splice(id + 1, 0, buildOtherEmotionData());
        this.deferSave();
      },
      onOtherEmotionRemove(id) {
        if (this.log.otherEmotions.length > 1) {
          this.log.otherEmotions.splice(id, 1);
          this.deferSave();
        }
      },
      onThoughtUpdate(index, field, value) {
        this.log.thoughts[index][field] = value;
        this.deferSave();
      },
      onDistortionUpdate(index, distortionId, value) {
        this.log.thoughts[index].distortions[distortionId] = value;
        this.deferSave();
      },
      onThoughtAdd(id) {
        this.log.thoughts.splice(id + 1, 0, buildThoughtData());
        this.deferSave();
      },
      onThoughtRemove(id) {
        if (this.log.thoughts.length > 1) {
          this.log.thoughts.splice(id, 1);
          this.deferSave();
        }
      },
    },
  };
</script>

<style lang='scss' scoped>
  @import '~styles/shared-styles.scss';
  .mood-log > div:not(:last-child) {
    margin-bottom: 3rem;
  }
  .header, .footer {
    text-align: center;
  }
</style>